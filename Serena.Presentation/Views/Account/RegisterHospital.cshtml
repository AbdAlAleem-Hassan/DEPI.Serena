@using Serena.BLL.Models.Account
@using Serena.BLL.Models.Hospitals
@model CreateAndUpdateHospitalDTO
@{
    ViewData["Title"] = "Register as Hospital";
    Layout = "~/Views/Shared/_AccountLayout.cshtml";
}

@section Styles {
    <style>
        /* Divider Styling */
        .section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
            margin: 1.5rem 0;
        }

        .dark-mode .section-divider {
            background-image: linear-gradient(to right, rgb(255 255 255 / 52%), rgb(255 255 255 / 15%), rgb(255 255 255 / 52%));
        }

        /* --------------------------------------
                                   Multi-Colored Card Logic (Cycle of 4)
                                   -------------------------------------- */

        /* Color 1: Blue (Default) */
        .dynamic-item:nth-of-type(4n+1) {
            border-left: 5px solid #3b82f6 !important;
            border-top: 5px solid #3b82f6 !important;
        }

            .dynamic-item:nth-of-type(4n+1) .card-header {
                background: linear-gradient(to right, #eff6ff, #fff);
                color: #1e40af;
            }

            .dynamic-item:nth-of-type(4n+1) .badge-indicator {
                background-color: #3b82f6;
            }

        /* Color 2: Emerald Green */
        .dynamic-item:nth-of-type(4n+2) {
            border-left: 5px solid #10b981 !important;
            border-top: 5px solid #10b981 !important;
        }

            .dynamic-item:nth-of-type(4n+2) .card-header {
                background: linear-gradient(to right, #ecfdf5, #fff);
                color: #065f46;
            }

            .dynamic-item:nth-of-type(4n+2) .badge-indicator {
                background-color: #10b981;
            }

        /* Color 3: Purple */
        .dynamic-item:nth-of-type(4n+3) {
            border-left: 5px solid #8b5cf6 !important;
            border-top: 5px solid #8b5cf6 !important;
        }

            .dynamic-item:nth-of-type(4n+3) .card-header {
                background: linear-gradient(to right, #f5f3ff, #fff);
                color: #5b21b6;
            }

            .dynamic-item:nth-of-type(4n+3) .badge-indicator {
                background-color: #8b5cf6;
            }

        /* Color 4: Orange */
        .dynamic-item:nth-of-type(4n+4) {
            border-left: 5px solid #f97316 !important;
            border-top: 5px solid #f97316 !important;
        }

            .dynamic-item:nth-of-type(4n+4) .card-header {
                background: linear-gradient(to right, #fff7ed, #fff);
                color: #9a3412;
            }

            .dynamic-item:nth-of-type(4n+4) .badge-indicator {
                background-color: #f97316;
            }
    </style>
}

<div class="auth-container">
    <div class="auth-card" style="max-width: 900px;">
        <div class="auth-header">
            <div class="auth-logo">
                <div class="logo-placeholder">S</div>
                <span class="logo-text">Serena</span>
            </div>
            <h2 class="auth-title">HOSPITAL REGISTRATION</h2>
            <p class="auth-subtitle">Register your healthcare facility profile</p>
        </div>

        <form class="auth-form" id="hospitalForm" asp-action="RegisterHospital" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="registration-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">General Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Departments</div>
                </div>
            </div>

            <div class="step-content active" data-step="1">
                <div class="section-title">Basic Details</div>

                <div class="form-group">
                    <label class="form-label" for="Name">Hospital Name</label>
                    <input asp-for="Name" class="form-input" placeholder="Enter hospital name" required />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="Rank">Rank</label>
                            <input asp-for="Rank" class="form-input" placeholder="e.g. Public, Private, A-Class" required />
                            <span asp-validation-for="Rank" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="AverageCost">Average Cost ($)</label>
                            <input asp-for="AverageCost" type="number" class="form-input" placeholder="0.00" required />
                            <span asp-validation-for="AverageCost" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="section-title mt-4">Contact Information</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="HospitalPhone">Hospital Phone</label>
                            <input asp-for="HospitalPhone" class="form-input" placeholder="Main phone number" required />
                            <span asp-validation-for="HospitalPhone" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="EmergencyPhone">Emergency Phone</label>
                            <input asp-for="EmergencyPhone" class="form-input" placeholder="Emergency hotline" required />
                            <span asp-validation-for="EmergencyPhone" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="section-title mt-4">Hospital Branding</div>
                <div class="image-upload-container" onclick="document.getElementById('Image').click()">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p class="mb-2">Click to upload hospital logo</p>
                    <p class="text-muted small">PNG, JPG up to 5MB</p>
                    <input asp-for="Image" type="file" id="Image" style="display: none;" accept="image/*" />
                    <img id="logoPreview" class="image-preview" />
                </div>
                <span asp-validation-for="Image" class="text-danger"></span>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" disabled>Previous</button>
                    <button type="button" class="btn-next" data-next="2">Next</button>
                </div>
            </div>

            <div class="step-content" data-step="2">
                <div style="display:flex; flex-direction:row; justify-content: space-between;">
                    <h3 style="flex: 2;">Hospital Addresses</h3>
                    <button type="button" class="btn btn-primary btn-sm" id="btnAddAddress">
                        <i class="fas fa-plus"></i> Add Branch
                    </button>
                </div>

                <div id="addressesContainer">
                    <hr class="section-divider">
                    <div class="address-item dynamic-item card mb-4 shadow-sm" data-index="0" style="border-radius: 12px; overflow: hidden;">
                        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 3px;">
                            <div style="display:flex; flex-direction: column; align-items: center; justify-content: center;">
                                <h3 class="m-0 fw-bold text-center" style="font-size: 1.25rem;">Main Branch</h3>
                                <span class="badge badge-indicator text-center" style="padding: 4px; color: white; border-radius: 5px;">Primary</span>
                            </div>
                        </div>

                        <div class="card-body" style="padding: 8px;">
                            <input type="hidden" name="Address[0].IsPrimary" value="true" />
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">Street Address</label>
                                        <input name="Address[0].Street" class="form-input" required />
                                        <span class="text-danger field-validation-valid" data-valmsg-for="Address[0].Street"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">City</label>
                                        <input name="Address[0].City" class="form-input" required />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">District</label>
                                        <input name="Address[0].District" class="form-input" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Country</label>
                                        <input name="Address[0].Country" class="form-input" required />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Zip Code</label>
                                        <input name="Address[0].ZipCode" class="form-input" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Latitude</label>
                                        <input name="Address[0].Latitude" type="number" step="any" class="form-input" required />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Longitude</label>
                                        <input name="Address[0].Longitude" type="number" step="any" class="form-input" required />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" data-prev="1">Previous</button>
                    <button type="button" class="btn-next" data-next="3">Next</button>
                </div>
            </div>

            <div class="step-content" data-step="3">
                <div style="display:flex; flex-direction:row; justify-content: space-between;">
                    <h3 style="flex: 2;">Hospital Departments</h3>
                    <button type="button" class="btn btn-primary btn-sm" id="btnAddDepartment">
                        <i class="fas fa-plus"></i> Add Department
                    </button>
                </div>

                <hr class="section-divider">

                <div id="departmentsContainer">
                    <div class="department-item dynamic-item card mb-4 shadow-sm" data-index="0" style="border-radius: 12px; overflow: hidden;">
                        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 3px;">
                            <div style="display:flex; flex-direction: column; align-items: center; justify-content: center;">
                                <h3 class="m-0 fw-bold text-center" style="font-size: 1.25rem;">Department</h3>
                            </div>
                        </div>

                        <div class="card-body" style="padding: 8px;">
                            <div class="form-group">
                                <label class="form-label">Department Name</label>
                                <input name="Department[0].Name" class="form-input" placeholder="e.g. Cardiology" required />
                                <span class="text-danger field-validation-valid" data-valmsg-for="Department[0].Name"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Description (Optional)</label>
                                <textarea name="Department[0].Description" class="form-input" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" data-prev="2">Previous</button>
                    <button type="submit" class="auth-submit-btn">
                        <span class="btn-text">Complete Registration</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<template id="addressTemplate">
    <div class="address-item dynamic-item card shadow-sm" data-index="{index}" style="border-radius: 12px; overflow: hidden; margin-top: 10px;">
        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 4px;">
            <h3 class="m-0 fw-bold" style="flex: 2; font-size: 1.25rem;">Branch #{displayIndex}</h3>
            <button type="button" class="btn btn-danger btn-sm btn-remove-item" style="background-color: #ffc3c3;" onclick="removeItem(this)">
                <i class="fas fa-trash-alt" style="color: red; padding: 2px;"></i> Remove
            </button>
        </div>

        <div class="card-body" style="padding: 8px;">
            <input type="hidden" name="Address[{index}].IsPrimary" value="false" />
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label">Street Address</label>
                        <input name="Address[{index}].Street" class="form-input" required />
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input name="Address[{index}].City" class="form-input" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">District</label>
                        <input name="Address[{index}].District" class="form-input" required />
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <input name="Address[{index}].Country" class="form-input" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Zip Code</label>
                        <input name="Address[{index}].ZipCode" class="form-input" required />
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Latitude</label>
                        <input name="Address[{index}].Latitude" type="number" step="any" class="form-input" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Longitude</label>
                        <input name="Address[{index}].Longitude" type="number" step="any" class="form-input" required />
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="departmentTemplate">
    <div class="department-item dynamic-item card mb-4 shadow-sm" data-index="{index}" style="border-radius: 12px; overflow: hidden; margin-top: 10px;">
        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 4px;">
            <h3 class="m-0 fw-bold" style="flex: 2; font-size: 1.25rem;">Department #{displayIndex}</h3>
            <button type="button" class="btn btn-danger btn-sm btn-remove-item" style="background-color: #ffc3c3;" onclick="removeItem(this)">
                <i class="fas fa-trash-alt" style="color: red; padding: 2px;"></i> Remove
            </button>
        </div>

        <div class="card-body" style="padding: 8px;">
            <div class="form-group">
                <label class="form-label">Department Name</label>
                <input name="Department[{index}].Name" class="form-input" required />
            </div>

            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea name="Department[{index}].Description" class="form-input" rows="2"></textarea>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initRegistrationSteps();
            initDynamicForms();

            // Image preview
            const logoInput = document.getElementById('Image');
            const logoPreview = document.getElementById('logoPreview');

            if (logoInput && logoPreview) {
                logoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            logoPreview.src = e.target.result;
                            logoPreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // Dynamic Form Handling
        function initDynamicForms() {
            // Add Address
            document.getElementById('btnAddAddress').addEventListener('click', function() {
                const container = document.getElementById('addressesContainer');
                const index = container.querySelectorAll('.address-item').length;
                const template = document.getElementById('addressTemplate').innerHTML;

                const newHtml = template
                    .replace(/{index}/g, index)
                    .replace(/{displayIndex}/g, index + 1);

                container.insertAdjacentHTML('beforeend', newHtml);
            });

            // Add Department
            document.getElementById('btnAddDepartment').addEventListener('click', function() {
                const container = document.getElementById('departmentsContainer');
                const index = container.querySelectorAll('.department-item').length;
                const template = document.getElementById('departmentTemplate').innerHTML;

                const newHtml = template
                    .replace(/{index}/g, index)
                    .replace(/{displayIndex}/g, index + 1);

                container.insertAdjacentHTML('beforeend', newHtml);
            });
        }

        // Remove item function
        window.removeItem = function(btn) {
            const item = btn.closest('.address-item, .department-item');
            if(item) item.remove();
        };

        function initRegistrationSteps() {
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            const nextButtons = document.querySelectorAll('.btn-next');
            const prevButtons = document.querySelectorAll('.btn-prev');

            function updateProgress(currentStep) {
                steps.forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    if (stepNum < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (stepNum === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                stepContents.forEach(content => {
                    const contentStep = parseInt(content.dataset.step);
                    if (contentStep === currentStep) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                prevButtons.forEach(btn => {
                    btn.disabled = currentStep === 1;
                });
            }

            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentStep = getCurrentStep();
                    const nextStep = parseInt(this.dataset.next);
                    if (validateStep(currentStep)) {
                        updateProgress(nextStep);
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const prevStep = parseInt(this.dataset.prev);
                    updateProgress(prevStep);
                });
            });

            function getCurrentStep() {
                const activeStep = document.querySelector('.step.active');
                return activeStep ? parseInt(activeStep.dataset.step) : 1;
            }

            function validateStep(step) {
                const currentContent = document.querySelector(`.step-content[data-step="${step}"]`);
                const requiredFields = currentContent.querySelectorAll('[required], input[data-val-required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                        field.style.borderColor = 'red';
                    } else {
                        field.classList.remove('error');
                        field.style.borderColor = '#e2e8f0';
                    }
                });

                if (!isValid) {
                    if(typeof showNotification === 'function') {
                        showNotification('Please fill all required fields', 'error');
                    } else {
                        alert('Please fill all required fields');
                    }
                }
                return isValid;
            }
        }
    </script>
}