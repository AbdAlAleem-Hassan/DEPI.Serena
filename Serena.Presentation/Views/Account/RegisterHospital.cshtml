@using Serena.BLL.Models.Account
@using Serena.BLL.Models.Hospitals
@model CreateAndUpdateHospitalDTO
@{
    ViewData["Title"] = "Register as Hospital";
    Layout = "~/Views/Shared/_AccountLayout.cshtml";
}

@section Styles {
    <style>
        /* Divider Styling */
        .section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
            margin: 1.5rem 0;
        }

        .dark-mode .section-divider {
            background-image: linear-gradient(to right, rgb(255 255 255 / 52%), rgb(255 255 255 / 15%), rgb(255 255 255 / 52%));
        }

        /* Validation styles */
        .field-validation-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* --------------------------------------
                                   Multi-Colored Card Logic (Cycle of 4)
                                   -------------------------------------- */

        /* Color 1: Blue (Default) */
        .dynamic-item:nth-of-type(4n+1) {
            border-left: 5px solid #3b82f6 !important;
            border-top: 5px solid #3b82f6 !important;
        }

            .dynamic-item:nth-of-type(4n+1) .card-header {
                background: linear-gradient(to right, #eff6ff, #fff);
                color: #1e40af;
            }

            .dynamic-item:nth-of-type(4n+1) .badge-indicator {
                background-color: #3b82f6;
            }

        /* Color 2: Emerald Green */
        .dynamic-item:nth-of-type(4n+2) {
            border-left: 5px solid #10b981 !important;
            border-top: 5px solid #10b981 !important;
        }

            .dynamic-item:nth-of-type(4n+2) .card-header {
                background: linear-gradient(to right, #ecfdf5, #fff);
                color: #065f46;
            }

            .dynamic-item:nth-of-type(4n+2) .badge-indicator {
                background-color: #10b981;
            }

        /* Color 3: Purple */
        .dynamic-item:nth-of-type(4n+3) {
            border-left: 5px solid #8b5cf6 !important;
            border-top: 5px solid #8b5cf6 !important;
        }

            .dynamic-item:nth-of-type(4n+3) .card-header {
                background: linear-gradient(to right, #f5f3ff, #fff);
                color: #5b21b6;
            }

            .dynamic-item:nth-of-type(4n+3) .badge-indicator {
                background-color: #8b5cf6;
            }

        /* Color 4: Orange */
        .dynamic-item:nth-of-type(4n+4) {
            border-left: 5px solid #f97316 !important;
            border-top: 5px solid #f97316 !important;
        }

            .dynamic-item:nth-of-type(4n+4) .card-header {
                background: linear-gradient(to right, #fff7ed, #fff);
                color: #9a3412;
            }

            .dynamic-item:nth-of-type(4n+4) .badge-indicator {
                background-color: #f97316;
            }
    </style>
}

<div class="auth-container">
    <div class="auth-card" style="max-width: 900px;">
        <div class="auth-header">
            <div class="auth-logo">
                <div class="logo-placeholder">S</div>
                <span class="logo-text">Serena</span>
            </div>
            <h2 class="auth-title">HOSPITAL REGISTRATION</h2>
            <p class="auth-subtitle">Register your healthcare facility profile</p>
        </div>

        <form class="auth-form" id="hospitalForm" asp-action="RegisterHospital" method="post" enctype="multipart/form-data" novalidate>
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="registration-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">General Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Departments</div>
                </div>
            </div>

            <div class="step-content active" data-step="1">
                <div class="section-title">Basic Details</div>

                <div class="form-group">
                    <label class="form-label" for="Name">Hospital Name *</label>
                    <input asp-for="Name" class="form-input" placeholder="Enter hospital name" />
                    <span asp-validation-for="Name" class="field-validation-error"></span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="Rank">Rank *</label>
                            <input asp-for="Rank" class="form-input" placeholder="e.g. Public, Private, A-Class" />
                            <span asp-validation-for="Rank" class="field-validation-error"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="AverageCost">Average Cost ($) *</label>
                            <input asp-for="AverageCost" type="number" class="form-input" placeholder="0.00" />
                            <span asp-validation-for="AverageCost" class="field-validation-error"></span>
                        </div>
                    </div>
                </div>

                <div class="section-title mt-4">Contact Information</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="HospitalPhone">Hospital Phone *</label>
                            <input asp-for="HospitalPhone" class="form-input" placeholder="Main phone number" />
                            <span asp-validation-for="HospitalPhone" class="field-validation-error"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="EmergencyPhone">Emergency Phone *</label>
                            <input asp-for="EmergencyPhone" class="form-input" placeholder="Emergency hotline" />
                            <span asp-validation-for="EmergencyPhone" class="field-validation-error"></span>
                        </div>
                    </div>
                </div>

                <div class="section-title mt-4">Hospital Branding</div>
                <div class="image-upload-container" onclick="document.getElementById('Image').click()">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p class="mb-2">Click to upload hospital logo</p>
                    <p class="text-muted small">PNG, JPG up to 5MB</p>
                    <input asp-for="Image" type="file" id="Image" style="display: none;" accept="image/*" />
                    <img id="logoPreview" class="image-preview" />
                </div>
                <span asp-validation-for="Image" class="field-validation-error"></span>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" disabled>Previous</button>
                    <button type="button" class="btn-next" data-next="2">Next</button>
                </div>
            </div>

            <div class="step-content" data-step="2">
                <div style="display:flex; flex-direction:row; justify-content: space-between;">
                    <h3 style="flex: 2;">Hospital Addresses *</h3>
                    <button type="button" class="btn btn-primary btn-sm" id="btnAddAddress">
                        <i class="fas fa-plus"></i> Add Branch
                    </button>
                </div>

                <div id="addressesContainer">
                    <hr class="section-divider">
                    <div class="address-item dynamic-item card mb-4 shadow-sm" data-index="0" style="border-radius: 12px; overflow: hidden;">
                        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 3px;">
                            <div style="display:flex; flex-direction: column; align-items: center; justify-content: center;">
                                <h3 class="m-0 fw-bold text-center" style="font-size: 1.25rem;">Main Branch</h3>
                                <span class="badge badge-indicator text-center" style="padding: 4px; color: white; border-radius: 5px;">Primary</span>
                            </div>
                        </div>

                        <div class="card-body" style="padding: 8px;">
                            <input type="hidden" name="Address[0].IsPrimary" value="true" />
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">Street Address *</label>
                                        <input name="Address[0].Street" class="form-input address-street" />
                                        <span class="field-validation-valid address-street-error"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">City *</label>
                                        <input name="Address[0].City" class="form-input address-city" />
                                        <span class="field-validation-valid address-city-error"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">District *</label>
                                        <input name="Address[0].District" class="form-input address-district" />
                                        <span class="field-validation-valid address-district-error"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Country *</label>
                                        <input name="Address[0].Country" class="form-input address-country" />
                                        <span class="field-validation-valid address-country-error"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Zip Code *</label>
                                        <input name="Address[0].ZipCode" class="form-input address-zip" />
                                        <span class="field-validation-valid address-zip-error"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Latitude *</label>
                                        <input name="Address[0].Latitude" type="number" step="any" class="form-input address-lat" />
                                        <span class="field-validation-valid address-lat-error"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Longitude *</label>
                                        <input name="Address[0].Longitude" type="number" step="any" class="form-input address-lng" />
                                        <span class="field-validation-valid address-lng-error"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" data-prev="1">Previous</button>
                    <button type="button" class="btn-next" data-next="3">Next</button>
                </div>
            </div>

            <div class="step-content" data-step="3">
                <div style="display:flex; flex-direction:row; justify-content: space-between;">
                    <h3 style="flex: 2;">Hospital Departments *</h3>
                    <button type="button" class="btn btn-primary btn-sm" id="btnAddDepartment">
                        <i class="fas fa-plus"></i> Add Department
                    </button>
                </div>

                <hr class="section-divider">

                <div id="departmentsContainer">
                    <div class="department-item dynamic-item card mb-4 shadow-sm" data-index="0" style="border-radius: 12px; overflow: hidden;">
                        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 3px;">
                            <div style="display:flex; flex-direction: column; align-items: center; justify-content: center;">
                                <h3 class="m-0 fw-bold text-center" style="font-size: 1.25rem;">Department</h3>
                            </div>
                        </div>

                        <div class="card-body" style="padding: 8px;">
                            <div class="form-group">
                                <label class="form-label">Department Name *</label>
                                <input name="Department[0].Name" class="form-input dept-name" placeholder="e.g. Cardiology" />
                                <span class="field-validation-valid dept-name-error"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Description (Optional)</label>
                                <textarea name="Department[0].Description" class="form-input" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="btn-prev" data-prev="2">Previous</button>
                    <button type="submit" class="auth-submit-btn" id="submitBtn">
                        <span class="btn-text">Complete Registration</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<template id="addressTemplate">
    <div class="address-item dynamic-item card shadow-sm" data-index="{index}" style="border-radius: 12px; overflow: hidden; margin-top: 10px;">
        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 4px;">
            <h3 class="m-0 fw-bold" style="flex: 2; font-size: 1.25rem;">Branch #{displayIndex}</h3>
            <button type="button" class="btn btn-danger btn-sm btn-remove-item" style="background-color: #ffc3c3;" onclick="removeItem(this)">
                <i class="fas fa-trash-alt" style="color: red; padding: 2px;"></i> Remove
            </button>
        </div>

        <div class="card-body" style="padding: 8px;">
            <input type="hidden" name="Address[{index}].IsPrimary" value="false" />
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label class="form-label">Street Address *</label>
                        <input name="Address[{index}].Street" class="form-input address-street" />
                        <span class="field-validation-valid address-street-error"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input name="Address[{index}].City" class="form-input address-city" />
                        <span class="field-validation-valid address-city-error"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">District *</label>
                        <input name="Address[{index}].District" class="form-input address-district" />
                        <span class="field-validation-valid address-district-error"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Country *</label>
                        <input name="Address[{index}].Country" class="form-input address-country" />
                        <span class="field-validation-valid address-country-error"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Zip Code *</label>
                        <input name="Address[{index}].ZipCode" class="form-input address-zip" />
                        <span class="field-validation-valid address-zip-error"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Latitude *</label>
                        <input name="Address[{index}].Latitude" type="number" step="any" class="form-input address-lat" />
                        <span class="field-validation-valid address-lat-error"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Longitude *</label>
                        <input name="Address[{index}].Longitude" type="number" step="any" class="form-input address-lng" />
                        <span class="field-validation-valid address-lng-error"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="departmentTemplate">
    <div class="department-item dynamic-item card mb-4 shadow-sm" data-index="{index}" style="border-radius: 12px; overflow: hidden; margin-top: 10px;">
        <div class="card-header" style="display:flex; align-items: center; justify-content: center; padding: 4px;">
            <h3 class="m-0 fw-bold" style="flex: 2; font-size: 1.25rem;">Department #{displayIndex}</h3>
            <button type="button" class="btn btn-danger btn-sm btn-remove-item" style="background-color: #ffc3c3;" onclick="removeItem(this)">
                <i class="fas fa-trash-alt" style="color: red; padding: 2px;"></i> Remove
            </button>
        </div>

        <div class="card-body" style="padding: 8px;">
            <div class="form-group">
                <label class="form-label">Department Name *</label>
                <input name="Department[{index}].Name" class="form-input dept-name" />
                <span class="field-validation-valid dept-name-error"></span>
            </div>

            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea name="Department[{index}].Description" class="form-input" rows="2"></textarea>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initRegistrationSteps();
            initDynamicForms();
            initImagePreview();
            initFormSubmission();
        });

        // صورة المستشفى
        function initImagePreview() {
            const logoInput = document.getElementById('Image');
            const logoPreview = document.getElementById('logoPreview');

            if (logoInput && logoPreview) {
                logoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // التحقق من حجم الملف (5MB كحد أقصى)
                        if (file.size > 5 * 1024 * 1024) {
                            showError('File size must be less than 5MB');
                            logoInput.value = '';
                            return;
                        }

                        // التحقق من نوع الملف
                        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                        if (!validTypes.includes(file.type)) {
                            showError('Only JPG, PNG files are allowed');
                            logoInput.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            logoPreview.src = e.target.result;
                            logoPreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // Dynamic Form Handling
        function initDynamicForms() {
            // Add Address
            document.getElementById('btnAddAddress').addEventListener('click', function() {
                const container = document.getElementById('addressesContainer');
                const index = container.querySelectorAll('.address-item').length;
                const template = document.getElementById('addressTemplate').innerHTML;

                const newHtml = template
                    .replace(/{index}/g, index)
                    .replace(/{displayIndex}/g, index + 1);

                container.insertAdjacentHTML('beforeend', newHtml);
            });

            // Add Department
            document.getElementById('btnAddDepartment').addEventListener('click', function() {
                const container = document.getElementById('departmentsContainer');
                const index = container.querySelectorAll('.department-item').length;
                const template = document.getElementById('departmentTemplate').innerHTML;

                const newHtml = template
                    .replace(/{index}/g, index)
                    .replace(/{displayIndex}/g, index + 1);

                container.insertAdjacentHTML('beforeend', newHtml);
            });
        }

        // Remove item function
        window.removeItem = function(btn) {
            const item = btn.closest('.address-item, .department-item');
            if(item) item.remove();
        };

        function initRegistrationSteps() {
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            const nextButtons = document.querySelectorAll('.btn-next');
            const prevButtons = document.querySelectorAll('.btn-prev');

            function updateProgress(currentStep) {
                steps.forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    if (stepNum < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (stepNum === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                stepContents.forEach(content => {
                    const contentStep = parseInt(content.dataset.step);
                    if (contentStep === currentStep) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                prevButtons.forEach(btn => {
                    btn.disabled = currentStep === 1;
                });
            }

            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentStep = getCurrentStep();
                    const nextStep = parseInt(this.dataset.next);
                    
                    if (validateStep(currentStep)) {
                        updateProgress(nextStep);
                    }
                });
            });

            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const prevStep = parseInt(this.dataset.prev);
                    updateProgress(prevStep);
                });
            });

            function getCurrentStep() {
                const activeStep = document.querySelector('.step.active');
                return activeStep ? parseInt(activeStep.dataset.step) : 1;
            }

            function validateStep(step) {
                let isValid = true;
                
                // إخفاء جميع رسائل الخطأ أولاً
                hideAllValidationErrors(step);
                
                switch(step) {
                    case 1:
                        isValid = validateStep1();
                        break;
                    case 2:
                        isValid = validateStep2();
                        break;
                    case 3:
                        isValid = validateStep3();
                        break;
                }
                
                return isValid;
            }
        }

        // التحقق من الخطوة 1
        function validateStep1() {
            let isValid = true;
            
            const fields = [
                { 
                    id: 'Name', 
                    errorMsg: 'Hospital name is required',
                    validation: (value) => value && value.trim().length > 0
                },
                { 
                    id: 'Rank', 
                    errorMsg: 'Rank is required',
                    validation: (value) => value && value.trim().length > 0
                },
                { 
                    id: 'AverageCost', 
                    errorMsg: 'Average cost is required and must be a valid number',
                    validation: (value) => {
                        if (!value) return false;
                        const num = parseFloat(value);
                        return !isNaN(num) && num >= 0;
                    }
                },
                { 
                    id: 'HospitalPhone', 
                    errorMsg: 'Hospital phone is required',
                    validation: (value) => value && value.trim().length > 0
                },
                { 
                    id: 'EmergencyPhone', 
                    errorMsg: 'Emergency phone is required',
                    validation: (value) => value && value.trim().length > 0
                }
            ];
            
            fields.forEach(field => {
                const input = document.getElementById(field.id);
                const errorSpan = input ? input.nextElementSibling : null;
                
                if (!input || !field.validation(input.value)) {
                    isValid = false;
                    if (input) {
                        input.classList.add('input-error');
                        if (errorSpan && errorSpan.classList.contains('field-validation-error')) {
                            errorSpan.textContent = field.errorMsg;
                            errorSpan.style.display = 'block';
                        }
                    }
                } else {
                    if (input) {
                        input.classList.remove('input-error');
                        if (errorSpan && errorSpan.classList.contains('field-validation-error')) {
                            errorSpan.style.display = 'none';
                        }
                    }
                }
            });
            
            if (!isValid) {
                showError('Please fill all required fields correctly');
            }
            
            return isValid;
        }

        // التحقق من الخطوة 2 (العناوين)
        function validateStep2() {
            let isValid = true;
            const addressItems = document.querySelectorAll('.address-item');
            
            if (addressItems.length === 0) {
                showError('At least one hospital address is required');
                return false;
            }
            
            addressItems.forEach((item, itemIndex) => {
                const addressFields = [
                    { 
                        selector: '.address-street', 
                        errorMsg: 'Street address is required',
                        validation: (value) => value && value.trim().length > 0
                    },
                    { 
                        selector: '.address-city', 
                        errorMsg: 'City is required',
                        validation: (value) => value && value.trim().length > 0
                    },
                    { 
                        selector: '.address-district', 
                        errorMsg: 'District is required',
                        validation: (value) => value && value.trim().length > 0
                    },
                    { 
                        selector: '.address-country', 
                        errorMsg: 'Country is required',
                        validation: (value) => value && value.trim().length > 0
                    },
                    { 
                        selector: '.address-zip', 
                        errorMsg: 'Zip code is required',
                        validation: (value) => value && value.trim().length > 0
                    },
                    { 
                        selector: '.address-lat', 
                        errorMsg: 'Valid latitude is required',
                        validation: (value) => {
                            if (!value) return false;
                            const lat = parseFloat(value);
                            return !isNaN(lat) && lat >= -90 && lat <= 90;
                        }
                    },
                    { 
                        selector: '.address-lng', 
                        errorMsg: 'Valid longitude is required',
                        validation: (value) => {
                            if (!value) return false;
                            const lng = parseFloat(value);
                            return !isNaN(lng) && lng >= -180 && lng <= 180;
                        }
                    }
                ];
                
                addressFields.forEach(field => {
                    const input = item.querySelector(field.selector);
                    const errorSpan = input ? input.nextElementSibling : null;
                    
                    if (!input || !field.validation(input.value)) {
                        isValid = false;
                        if (input) {
                            input.classList.add('input-error');
                            if (errorSpan && errorSpan.classList.contains('field-validation-valid')) {
                                errorSpan.textContent = field.errorMsg;
                                errorSpan.style.color = '#dc3545';
                                errorSpan.style.display = 'block';
                            }
                        }
                    } else {
                        if (input) {
                            input.classList.remove('input-error');
                            if (errorSpan && errorSpan.classList.contains('field-validation-valid')) {
                                errorSpan.style.display = 'none';
                            }
                        }
                    }
                });
            });
            
            if (!isValid) {
                showError('Please fill all address fields correctly');
            }
            
            return isValid;
        }

        // التحقق من الخطوة 3 (الأقسام)
        function validateStep3() {
            let isValid = true;
            const deptItems = document.querySelectorAll('.department-item');
            
            if (deptItems.length === 0) {
                showError('At least one department is required');
                return false;
            }
            
            deptItems.forEach((item, itemIndex) => {
                const deptNameInput = item.querySelector('.dept-name');
                const errorSpan = deptNameInput ? deptNameInput.nextElementSibling : null;
                
                if (!deptNameInput || !deptNameInput.value || deptNameInput.value.trim().length === 0) {
                    isValid = false;
                    if (deptNameInput) {
                        deptNameInput.classList.add('input-error');
                        if (errorSpan && errorSpan.classList.contains('dept-name-error')) {
                            errorSpan.textContent = 'Department name is required';
                            errorSpan.style.color = '#dc3545';
                            errorSpan.style.display = 'block';
                        }
                    }
                } else {
                    if (deptNameInput) {
                        deptNameInput.classList.remove('input-error');
                        if (errorSpan && errorSpan.classList.contains('dept-name-error')) {
                            errorSpan.style.display = 'none';
                        }
                    }
                }
            });
            
            if (!isValid) {
                showError('Please fill all department names');
            }
            
            return isValid;
        }

        // إخفاء جميع أخطاء التحقق
        function hideAllValidationErrors(step) {
            const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
            if (!stepContent) return;
            
            // إخفاء رسائل الخطأ
            const errorSpans = stepContent.querySelectorAll('.field-validation-error, .field-validation-valid');
            errorSpans.forEach(span => {
                span.style.display = 'none';
                span.textContent = '';
            });
            
            // إزالة تظليل الحقول
            const inputs = stepContent.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.classList.remove('input-error');
            });
        }

        // التحقق النهائي قبل الإرسال
        function initFormSubmission() {
            const form = document.getElementById('hospitalForm');
            const submitBtn = document.getElementById('submitBtn');
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    // التحقق من جميع الخطوات قبل الإرسال
                    const isStep1Valid = validateStep1();
                    const isStep2Valid = validateStep2();
                    const isStep3Valid = validateStep3();
                    
                    if (!isStep1Valid || !isStep2Valid || !isStep3Valid) {
                        e.preventDefault();
                        
                        // الانتقال إلى أول خطوة بها خطأ
                        if (!isStep1Valid) {
                            updateProgress(1);
                        } else if (!isStep2Valid) {
                            updateProgress(2);
                        } else {
                            updateProgress(3);
                        }
                        
                        showError('Please fix all validation errors before submitting');
                    }
                });
            }
        }

        // وظيفة لعرض رسائل الخطأ
        function showError(message) {
            // يمكنك استبدال هذا بمنظومة التنبيهات الخاصة بك
            if (typeof showNotification === 'function') {
                showNotification(message, 'error');
            } else {
                alert('Error: ' + message);
            }
        }

        // وظيفة لعرض رسائل النجاح
        function showSuccess(message) {
            if (typeof showNotification === 'function') {
                showNotification(message, 'success');
            } else {
                alert('Success: ' + message);
            }
        }
    </script>
}