@model Serena.BLL.Models.Hospitals.HospitalDetailsDTO

@{
    var primaryAddress = Model.Addresses?.FirstOrDefault();
    var reviewCount = (Model.PatientHospitalReviews?.Count ?? 0) + (Model.DoctorHospitalReviews?.Count ?? 0);
    var averageRating = 0.0;
    if (reviewCount > 0)
    {
        var patientRatings = Model.PatientHospitalReviews?.Select(r => r.Rating).ToList() ?? new List<int>();
        var doctorRatings = Model.DoctorHospitalReviews?.Select(r => r.Rating).ToList() ?? new List<int>();
        var allRatings = patientRatings.Concat(doctorRatings).ToList();
        averageRating = allRatings.Any() ? allRatings.Average() : 0;
    }
}

<div class="hospital-card">

    <!-- COL 1: Identity (Wrapper for Image + Name) -->
    <!-- Grid: display: contents -> Image and Text split -->
    <!-- List: display: flex -> Image and Text side-by-side in Col 1 -->
    <div class="hospital-identity">

        <!-- Part A: Image -->
        <div class="card-img-wrapper">
            <!-- Placeholder since DTO has no image -->
            <i class="fas fa-hospital" style="font-size: 2rem; color: #475569;"></i>

            <!-- Rank Badge for Grid -->
            @if (!string.IsNullOrEmpty(Model.Rank))
            {
                <div class="badge-rank grid-only"
                    style="position: absolute; top: 1rem; right: 1rem; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; padding: 4px 8px; border-radius: 6px; font-weight: 700; backdrop-filter: blur(4px);">
                    #@Model.Rank
                </div>
            }
        </div>

        <!-- Part B: Text -->
        <div class="hospital-info-text" style="flex:1">
            <h3 class="hospital-name">@Model.Name</h3>

            @if (primaryAddress != null)
            {
                <div class="hospital-location">
                    <i class="fas fa-map-marker-alt"></i> <span>@primaryAddress.City, @primaryAddress.Country</span>
                </div>
            }
        </div>
    </div>

    <!-- WRAPPER FOR REMAINING CELLS (Flattened in List Mode) -->
    <div class="card-content">

        <!-- COL 2: Rank (List Only) -->
        <div class="list-cell list-only">
            @if (!string.IsNullOrEmpty(Model.Rank))
            {
                <span class="badge-rank">#@Model.Rank</span>
            }
            else
            {
                <span style="color:#64748B">-</span>
            }
        </div>

        <!-- COL 3: Departments (Tags) -->
        <div class="list-cell">
            <!-- Grid view shows tags separately below -->
            <div class="grid-only hospital-departments">
                @if (Model.Departments != null)
                {
                    foreach (var dept in Model.Departments.Take(3))
                    {
                        <span class="department-tag">@dept.Name</span>
                    }
                    if (Model.Departments.Count > 3)
                    {
                        <span class="department-tag" style="background:transparent; color:#94A3B8">+@(Model.Departments.Count -
                                                3)</span>
                    }
                }
            </div>

            <!-- List view: just count or text -->
            <div class="list-only">
                @(Model.Departments?.Count ?? 0) Departments
            </div>
        </div>

        <!-- COL 4: Rating -->
        <div class="list-cell rating-cell list-only">
            <i class="fas fa-star"></i> @averageRating.ToString("0.1") <span
                style="color:#64748B; font-weight:400; font-size:0.8rem">(@reviewCount)</span>
        </div>

        <!-- COL 5: Cost -->
        <div class="list-cell list-only" style="font-weight: 700; color: #10B981;">
            $@Model.AverageCost.ToString("N0")
        </div>

        <!-- Grid Only: Stats Row (To look like Doctor Premium Grid) -->
        <div class="grid-stats-row grid-only">
            <div class="grid-stat">
                <h4>@reviewCount</h4>
                <span>Reviews</span>
            </div>
            <div class="grid-stat">
                <h4>@averageRating.ToString("0.1")</h4>
                <span>Rating</span>
            </div>
            <div class="grid-stat">
                <h4>$@Model.AverageCost.ToString("N0")</h4>
                <span>Avg Cost</span>
            </div>
        </div>

        <!-- COL 6: Actions -->
        <div class="card-actions-row">
            <a asp-controller="Appointment" asp-action="Create" asp-route-hospitalId="@Model.Id"
                class="btn-primary-card">
                <i class="fas fa-calendar-alt"></i>
                <span>Book</span>
            </a>

            <a asp-action="Details" asp-route-id="@Model.Id" class="btn-icon-card grid-only"
                style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; border-radius: 6px; width: auto; background: linear-gradient(to right, #6366f1, #a855f7); color: white;">
                <i class="fas fa-eye"></i>
                <span>View</span>
            </a>

            <a asp-action="Details" asp-route-id="@Model.Id" class="btn-icon-card list-only">
                <i class="fas fa-eye"></i>
            </a>
        </div>
    </div>
</div>