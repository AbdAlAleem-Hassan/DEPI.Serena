@model IEnumerable<Serena.BLL.Models.Hospitals.HospitalDetailsDTO>

@{
    ViewData["Title"] = "Find Hospitals - Serena";

    // Re-map ViewBag for cleaner usage
    var name = ViewBag.Name as string ?? "";
    var city = ViewBag.City as string ?? "";
    var department = ViewBag.Department as string ?? "";
    var country = ViewBag.Country as string ?? "";
    var rank = ViewBag.Rank as string ?? "";
    var maxCost = ViewBag.MaxAverageCost as decimal?;
    var sortBy = ViewBag.SortBy as string ?? "name";

    // Assuming simple pagination or list view.
    // The original logic handles pagination in the Controller.
    var totalCount = ViewBag.TotalCount ?? (Model?.Count() ?? 0);
}

@section Styles {
    <link rel="stylesheet" href="~/css/hospitals.css">
    <link rel="stylesheet" href="~/css/toaster.css">
}

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-new"></div>
    <div class="loading-text">Loading...</div>
</div>

<div class="page-header">
    <div class="page-header-background"></div>
    <div class="page-header-orbs">
        <div class="page-header-orb"></div>
        <div class="page-header-orb"></div>
        <div class="page-header-orb"></div>
    </div>
    <div class="container" style="position: relative; z-index: 10;">
        <h1 class="page-title">Find Top Hospitals</h1>
        <p class="page-subtitle">Discover world-class medical facilities with advanced technology and expert care.</p>
    </div>
</div>

<div class="search-section">
    <div class="container">

        <!-- SEARCH & FILTERS FORM -->
        <form method="get" asp-action="Index" id="filtersForm">
            <input type="hidden" name="sortBy" id="hiddenSortBy" value="@sortBy" />
            <input type="hidden" name="viewMode" id="viewModeInput" value="view-grid" />

            <!-- MAIN SEARCH BAR -->
            <div class="search-container-new">
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" name="name" class="search-input-new"
                        placeholder="Search for hospitals by name..." value="@name">
                </div>
                <button type="submit" class="search-btn-new">Search</button>
            </div>

            <!-- FILTERS CARD -->
            <div class="filters-card-new">
                <div class="filters-header-new">
                    <h3 class="filters-title-new"><i class="fas fa-sliders-h"
                            style="margin-right: 0.5rem; color: #3B82F6;"></i>Filters</h3>
                    <a asp-action="Index" class="btn-clear-all"><i class="fas fa-times"></i> Clear All</a>
                </div>

                <div class="filters-row">
                    <!-- City -->
                    <div class="filter-group-new">
                        <label>City</label>
                        <select name="city" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">All Cities</option>
                            @if (ViewBag.Cities != null)
                            {
                                foreach (var c in ViewBag.Cities)
                                {
                                    <option value="@c" selected="@(city == c)">@c</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Department -->
                    <div class="filter-group-new">
                        <label>Department</label>
                        <select name="department" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">All Departments</option>
                            @if (ViewBag.Departments != null)
                            {
                                foreach (var d in ViewBag.Departments)
                                {
                                    <option value="@d" selected="@(department == d)">@d</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Country -->
                    <div class="filter-group-new">
                        <label>Country</label>
                        <select name="country" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">All Countries</option>
                            @if (ViewBag.Countries != null)
                            {
                                foreach (var c in ViewBag.Countries)
                                {
                                    <option value="@c" selected="@(country == c)">@c</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Rank -->
                    <div class="filter-group-new">
                        <label>Rank</label>
                        <select name="rank" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">Any Rank</option>
                            @if (ViewBag.Ranks != null)
                            {
                                foreach (var r in ViewBag.Ranks)
                                {
                                    <option value="@r" selected="@(rank == r)">#@r</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Cost -->
                    <div class="filter-group-new">
                        <label>Max Cost ($)</label>
                        <input type="number" name="maxAverageCost" class="filter-input-new"
                            placeholder="Max Average Cost..." value="@maxCost" step="100" onchange="this.form.submit()">
                    </div>
                </div>

                <!-- Active Tags -->
                <div class="active-tags-container" style="margin-top: 1.5rem;">
                    @if (!string.IsNullOrEmpty(city))
                    {
                        <span class="active-tag" onclick="removeFilter('city')">@city <i
                                class="fas fa-times active-tag-close"></i></span>
                    }
                    @if (!string.IsNullOrEmpty(department))
                    {
                        <span class="active-tag" onclick="removeFilter('department')">@department <i
                                class="fas fa-times active-tag-close"></i></span>
                    }
                    @if (!string.IsNullOrEmpty(country))
                    {
                        <span class="active-tag" onclick="removeFilter('country')">@country <i
                                class="fas fa-times active-tag-close"></i></span>
                    }
                    @if (!string.IsNullOrEmpty(rank))
                    {
                        <span class="active-tag" onclick="removeFilter('rank')">Rank:
                            #@rank <i class="fas fa-times active-tag-close"></i></span>
                    }
                    @if (maxCost.HasValue)
                    {
                        <span class="active-tag" onclick="removeFilter('maxAverageCost')">Max:
                            $@maxCost <i class="fas fa-times active-tag-close"></i></span>
                    }
                </div>
            </div>
        </form>

        <!-- Results Header -->
        <div class="results-header-actions">
            <div class="results-count">
                <strong>@totalCount</strong> hospitals found
            </div>

            <div class="view-controls">
                <div class="view-btn-group">
                    <button type="button" class="view-btn active" id="btnGrid" onclick="setView('view-grid')">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" class="view-btn" id="btnList" onclick="setView('view-list')">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- Sort -->
                <select class="sort-select"
                    onchange="document.getElementById('hiddenSortBy').value=this.value; document.getElementById('filtersForm').submit();">
                    <option value="name" selected="@(sortBy == "name")">Name (A-Z)</option>
                    <option value="name_desc" selected="@(sortBy == "name_desc")">Name (Z-A)</option>
                    <option value="rank" selected="@(sortBy == "rank")">Rank (Low-High)</option>
                    <option value="rank_desc" selected="@(sortBy == "rank_desc")">Rank (High-Low)</option>
                    <option value="cost" selected="@(sortBy == "cost")">Cost (Low-High)</option>
                    <option value="cost_desc" selected="@(sortBy == "cost_desc")">Cost (High-Low)</option>
                </select>
            </div>
        </div>

        <!-- HOSPITALS LIST CONTAINER -->
        <div id="hospitalsContainer" class="hospitals-container view-grid">

            <!-- List Header (List Mode Only) -->
            <div class="hospitals-list-header">
                <div class="list-header-item">Hospital</div>
                <div class="list-header-item">Rank</div>
                <div class="list-header-item">Avg Cost</div>
                <div class="list-header-item">Phone</div>
                <div class="list-header-item">Ambulance</div>
                <div class="list-header-item" style="text-align:right">Actions</div>
            </div>

            @if (Model != null && Model.Any())
            {
                foreach (var hospital in Model)
                {
                    @await Html.PartialAsync("_HospitalCard", hospital)
                }
            }
            else
            {
                <div class="no-results" style="grid-column: 1/-1; text-align:center; padding: 4rem; color: #94A3B8;">
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>No hospitals found matching your criteria.</p>
                </div>
            }
        </div>

        <!-- Pagination -->
        @* @if (totalPages > 1)
        {
            <div class="pagination-container">
                @if (pageNumber > 1)
                {
                    <a href="@Url.Action("Index", new { pageNumber = pageNumber - 1, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                }

                @for (int i = 1; i <= totalPages; i++)
                {
                    <a href="@Url.Action("Index", new { pageNumber = i, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn @(i == pageNumber ? "active" : "")">
                        @i
                    </a>
                }

                @if (pageNumber < totalPages)
                {
                    <a href="@Url.Action("Index", new { pageNumber = pageNumber + 1, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                }

                <span style="margin-left: 1rem;">Showing @((pageNumber - 1) * pageSize + 1)-@(Math.Min((int)(pageNumber *
                                    pageSize), (int)totalCount)) of @totalCount</span>
            </div>
        } *@
    </div>
</div>

@section Scripts {
    <script>
        // --- View Mode Toggle ---
        function setView(mode) {
            const container = document.getElementById('hospitalsContainer');
            const btnGrid = document.getElementById('btnGrid');
            const btnList = document.getElementById('btnList');
            const hiddenInput = document.getElementById('viewModeInput');

            // Apply Classes
            container.className = `hospitals-container ${mode}`;

            // Update Buttons
            if (mode === 'view-grid') {
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
            } else {
                btnList.classList.add('active');
                btnGrid.classList.remove('active');
            }

            // Save State
            localStorage.setItem('hospitalViewMode', mode);
            if (hiddenInput) hiddenInput.value = mode;
        }

        // --- Load Saved View Mode ---
        document.addEventListener('DOMContentLoaded', function () {
            const savedMode = localStorage.getItem('hospitalViewMode') || 'view-grid';
            setView(savedMode);
        });

        // --- Active Tags Logic ---
        function removeFilter(filterName) {
            const form = document.getElementById('filtersForm');
            // Find input/select by name and reset
            const input = form.querySelector(`[name="${filterName}"]`);
            if (input) {
                input.value = '';
                form.submit();
            }
        }

        const form = document.getElementById('filtersForm');
        form.addEventListener('submit', function () {
            document.getElementById('loadingOverlay').style.display = 'flex';
        });
    </script>
}