@model List<Serena.BLL.Models.Doctors.DoctorDetailsDTO>

@{
    ViewData["Title"] = "Find Doctors - Serena";

    // View data
    var name = ViewBag.Name as string ?? "";
    var specialization = ViewBag.Specialization as string ?? "";
    var city = ViewBag.City as string ?? "";
    var yearsOfExperience = ViewBag.YearsOfExperience as int? ?? 0;
    var sortBy = ViewBag.SortBy as string ?? "name_asc";

    // Pagination
    var pageNumber = ViewBag.PageNumber as int? ?? 1;
    var pageSize = ViewBag.PageSize as int? ?? 9;
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var totalPages = ViewBag.TotalPages as int? ?? 1;

    // Dropdowns
    var specializations = ViewBag.Specializations as List<string> ?? new List<string>();
    var cities = ViewBag.Cities as List<string> ?? new List<string>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/doctors.css">
    <link rel="stylesheet" href="~/css/toaster.css">
}

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-new"></div>
    <div class="loading-text">Loading...</div>
</div>

<!-- Page Header -->
<section class="page-header">
    <div class="page-header-background">
        <div class="page-header-orbs">
            <div class="page-header-orb"></div>
            <div class="page-header-orb"></div>
        </div>
    </div>
    <div class="container">
        <h1 class="page-title">Find Your Doctor</h1>
        <p class="page-subtitle">Book appointments with the best specialists in your area.</p>
    </div>
</section>

<!-- Search & Content Section -->
<section class="search-section">
    <div class="container">

        <form method="get" action="@Url.Action("Index")" id="filtersForm">
            <input type="hidden" name="pageNumber" value="1" />
            <input type="hidden" name="pageSize" value="@pageSize" />
            <input type="hidden" name="sortBy" id="hiddenSortBy" value="@sortBy" />

            <!-- Search Bar -->
            <div class="search-container-new">
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" name="name" class="search-input-new" placeholder="Search by doctor name..."
                        value="@name">
                </div>
                <button type="submit" class="search-btn-new">Search</button>
            </div>

            <!-- Filters Card -->
            <div class="filters-card-new">
                <div class="filters-header-new">
                    <h3 class="filters-title-new"><i class="fas fa-sliders-h"
                            style="margin-right: 0.5rem; color: #3B82F6;"></i>Filters</h3>
                    <a href="@Url.Action("Index")" class="btn-clear-all"><i class="fas fa-times"></i> Clear All</a>
                </div>

                <div class="filters-row">
                    <!-- Specialty -->
                    <div class="filter-group-new">
                        <label>Specialty</label>
                        <select name="specialization" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">All Specialties</option>
                            @foreach (var spec in specializations)
                            {
                                <option value="@spec" selected="@(spec == specialization)">@spec</option>
                            }
                        </select>
                    </div>

                    <!-- City -->
                    <div class="filter-group-new">
                        <label>City</label>
                        <select name="city" class="filter-select-new" onchange="this.form.submit()">
                            <option value="">All Cities</option>
                            @foreach (var c in cities)
                            {
                                <option value="@c" selected="@(c == city)">@c</option>
                            }
                        </select>
                    </div>

                    <!-- Experience -->
                    <div class="filter-group-new">
                        <label>Experience</label>
                        <select name="yearsOfExperience" class="filter-select-new" onchange="this.form.submit()">
                            <option value="0" selected="@(yearsOfExperience == 0)">Any Experience</option>
                            <option value="5" selected="@(yearsOfExperience == 5)">5+ Years</option>
                            <option value="10" selected="@(yearsOfExperience == 10)">10+ Years</option>
                            <option value="15" selected="@(yearsOfExperience == 15)">15+ Years</option>
                            <option value="20" selected="@(yearsOfExperience == 20)">20+ Years</option>
                            <option value="25" selected="@(yearsOfExperience == 25)">25+ Years</option>
                            <option value="30" selected="@(yearsOfExperience == 30)">30+ Years</option>
                            <option value="35" selected="@(yearsOfExperience == 35)">35+ Years</option>
                            <option value="40" selected="@(yearsOfExperience == 40)">40+ Years</option>
                            <option value="45" selected="@(yearsOfExperience == 45)">45+ Years</option>
                            <option value="50" selected="@(yearsOfExperience == 50)">50+ Years</option>
                        </select>
                    </div>
                </div>

                <!-- Active Tags (Dynamic)-->
                <div class="active-tags-container" style="margin-top: 1.5rem;">
                    @if (!string.IsNullOrEmpty(specialization))
                    {
                        <button type="button" class="active-tag" onclick="clearFilter('specialization')">
                            Specialty: @specialization <span class="active-tag-close">&times;</span>
                        </button>
                    }
                    @if (!string.IsNullOrEmpty(city))
                    {
                        <button type="button" class="active-tag" onclick="clearFilter('city')">
                            City: @city <span class="active-tag-close">&times;</span>
                        </button>
                    }
                    @if (yearsOfExperience > 0)
                    {
                        <button type="button" class="active-tag" onclick="clearFilter('yearsOfExperience')">
                            Exp: @yearsOfExperience+ Years <span class="active-tag-close">&times;</span>
                        </button>
                    }
                    @if (!string.IsNullOrEmpty(sortBy))
                    {
                        // Optional: Show sort as tag or just keep dropdown
                    }
                </div>
            </div>
        </form>

        <!-- Results Header -->
        <div class="results-header-actions">
            <div class="results-count">
                Showing @((pageNumber - 1) * pageSize + 1)-@(Math.Min((int)(pageNumber * pageSize), (int)totalCount)) of
                @totalCount
            </div>

            <div class="view-controls">
                <!-- View Toggle -->
                <div class="view-btn-group">
                    <button type="button" class="view-btn active" id="btnGrid" onclick="setView('view-grid')">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" class="view-btn" id="btnList" onclick="setView('view-list')">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <!-- Sort -->
                <select class="sort-select"
                    onchange="document.getElementById('hiddenSortBy').value=this.value; document.getElementById('filtersForm').submit();">
                    <option value="name_asc" selected="@(sortBy == "name_asc")">Name (A-Z)</option>
                    <option value="name_desc" selected="@(sortBy == "name_desc")">Name (Z-A)</option>
                    <option value="exp_desc" selected="@(sortBy == "exp_desc")">Experience (High-Low)</option>
                    <option value="exp_asc" selected="@(sortBy == "exp_asc")">Experience (Low-High)</option>
                    <option value="rate_desc" selected="@(sortBy == "rate_desc")">Rating (High-Low)</option>
                    <option value="rate_asc" selected="@(sortBy == "rate_asc")">Rating (Low-High)</option>
                </select>
            </div>
        </div>

        <!-- Default to Grid, managed by JS toggling class -->
        <div id="doctorsContainer" class="doctors-container view-grid">

            <!-- List Header (List Mode Only) -->
            <div class="doctors-list-header">
                <div class="list-header-item">Doctor</div>
                <div class="list-header-item">Specialty</div>
                <div class="list-header-item">Rating</div>
                <div class="list-header-item">Experience</div>
                <div class="list-header-item">Fee</div>
                <div class="list-header-item">Available</div>
                <div class="list-header-item" style="text-align:right">Actions</div>
            </div>
            @if (Model.Count == 0)
            {
                <div class="no-results" style="grid-column: 1/-1; text-align:center; padding: 4rem; color: #94A3B8;">
                    <i class="far fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>No doctors found</h3>
                </div>
            }
            else
            {
                @foreach (var doctor in Model)
                {
                    @await Html.PartialAsync("_DoctorCard", doctor)
                }
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination-container">
                @if (pageNumber > 1)
                {
                    <a href="@Url.Action("Index", new { pageNumber = pageNumber - 1, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                }

                @for (int i = 1; i <= totalPages; i++)
                {
                    <a href="@Url.Action("Index", new { pageNumber = i, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn @(i == pageNumber ? "active" : "")">
                        @i
                    </a>
                }

                @if (pageNumber < totalPages)
                {
                    <a href="@Url.Action("Index", new { pageNumber = pageNumber + 1, pageSize, name, specialization, city, yearsOfExperience, sortBy })"
                        class="pagination-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                }

                <span style="margin-left: 1rem;">Showing @((pageNumber - 1) * pageSize + 1)-@(Math.Min((int)(pageNumber *
                                    pageSize), (int)totalCount)) of @totalCount</span>
            </div>
        }

    </div>
</section>

@section Scripts {
    <script>
        // --- View Toggle Logic ---
        function setView(mode) {
            const container = document.getElementById('doctorsContainer');
            const btnGrid = document.getElementById('btnGrid');
            const btnList = document.getElementById('btnList');

            // Remove both first to be safe
            container.classList.remove('view-grid', 'view-list');
            container.classList.add(mode);

            // Update buttons
            if (mode === 'view-grid') {
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
                localStorage.setItem('doctorViewMode', 'grid');
            } else {
                btnList.classList.add('active');
                btnGrid.classList.remove('active');
                localStorage.setItem('doctorViewMode', 'list');
            }
        }

        // Initialize view from local storage
        document.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('doctorViewMode');
            if (savedMode === 'list') {
                setView('view-list');
            } else {
                setView('view-grid');
            }
        });

        // --- Filter Logic ---
        function clearFilter(filterName) {
            const form = document.getElementById('filtersForm');
            // Find input/select by name and reset
            const element = form.querySelector(`[name="${filterName}"]`);
            if (element) {
                element.value = "";
                form.submit();
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
        }

        const form = document.getElementById('filtersForm');
        form.addEventListener('submit', function () {
            document.getElementById('loadingOverlay').style.display = 'flex';
        });
    </script>
}